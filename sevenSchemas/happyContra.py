import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from crystal import Pipeline


def test_pipeline_no_overloads(capsys):
    service_flows = {
        "C1": {"S1": (100, 100), "S2": (0, 0), "S3": (0, 0), "S4": (0, 0), "S5": (0, 0), "S6": (0, 0), "S7": (0, 0)},
        "C2": {"S1": (0, 0), "S2": (100, 100), "S3": (0, 0), "S4": (0, 0), "S5": (0, 0), "S6": (0, 0), "S7": (0, 0)},
        "C3": {"S1": (0, 0), "S2": (0, 0), "S3": (100, 100), "S4": (0, 0), "S5": (0, 0), "S6": (0, 0), "S7": (0, 0)},
        "C4": {"S1": (0, 0), "S2": (0, 0), "S3": (0, 0), "S4": (100, 100), "S5": (0, 0), "S6": (0, 0), "S7": (0, 0)},
        "C5": {"S1": (0, 0), "S2": (0, 0), "S3": (0, 0), "S4": (0, 0), "S5": (100, 100), "S6": (0, 0), "S7": (0, 0)},
        "C6": {"S1": (0, 0), "S2": (0, 0), "S3": (0, 0), "S4": (0, 0), "S5": (0, 0), "S6": (100, 100), "S7": (0, 0)},
        "C7": {"S1": (0, 0), "S2": (0, 0), "S3": (0, 0), "S4": (0, 0), "S5": (0, 0), "S6": (0, 0), "S7": (100, 100)},
        "AggStream": {"S1": (80, 80), "S2": (80, 80), "S3": (80, 80), "S4": (80, 80), "S5": (80, 80), "S6": (80, 80), "S7": (80, 80)},
        "SlowLane": {"S1": (20, 20), "S2": (20, 20), "S3": (20, 20), "S4": (20, 20), "S5": (20, 20), "S6": (20, 20), "S7": (20, 20)},
        "R1": {"S1": (50, 50), "S2": (50, 50), "S3": (50, 50), "S4": (50, 50), "S5": (50, 50), "S6": (50, 50), "S7": (50, 50)},
        "R2": {"S1": (30, 30), "S2": (30, 30), "S3": (30, 30), "S4": (30, 30), "S5": (30, 30), "S6": (30, 30), "S7": (30, 30)},
        "CDIS1": {"S1": (15, 15), "S2": (15, 15), "S3": (15, 15), "S4": (15, 15), "S5": (15, 15), "S6": (15, 15), "S7": (15, 15)},
        "CDIS2": {"S1": (15, 15), "S2": (15, 15), "S3": (15, 15), "S4": (15, 15), "S5": (15, 15), "S6": (15, 15), "S7": (15, 15)},
        "CDIS3": {"S1": (20, 20), "S2": (20, 20), "S3": (20, 20), "S4": (20, 20), "S5": (20, 20), "S6": (20, 20), "S7": (20, 20)},
        "Hoth": {"S1": (30, 30), "S2": (30, 30), "S3": (30, 30), "S4": (30, 30), "S5": (30, 30), "S6": (30, 30), "S7": (30, 30)},
        "Bungee1": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee2": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee3": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee4": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee5": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee6": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee7": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee8": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee9": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
    }

    schema_capacities = {
        "C1": {"S1": (100, 200), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "C2": {"S1": (10, 20), "S2": (100, 200), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "C3": {"S1": (10, 20), "S2": (10, 20), "S3": (100, 200), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "C4": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (100, 200), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "C5": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (100, 200), "S6": (10, 20), "S7": (10, 20)},
        "C6": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (100, 200), "S7": (10, 20)},
        "C7": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (100, 200)},
        "AggStream": {"S1": (80, 150), "S2": (80, 150), "S3": (80, 150), "S4": (80, 150), "S5": (80, 150), "S6": (80, 150), "S7": (80, 150)},
        "SlowLane": {"S1": (20, 50), "S2": (20, 50), "S3": (20, 50), "S4": (20, 50), "S5": (20, 50), "S6": (20, 50), "S7": (20, 50)},
        "R1": {"S1": (50, 100), "S2": (50, 100), "S3": (50, 100), "S4": (50, 100), "S5": (50, 100), "S6": (50, 100), "S7": (50, 100)},
        "R2": {"S1": (30, 60), "S2": (30, 60), "S3": (30, 60), "S4": (30, 60), "S5": (30, 60), "S6": (30, 60), "S7": (30, 60)},
        "CDIS1": {"S1": (15, 30), "S2": (15, 30), "S3": (15, 30), "S4": (15, 30), "S5": (15, 30), "S6": (15, 30), "S7": (15, 30)},
        "CDIS2": {"S1": (15, 30), "S2": (15, 30), "S3": (15, 30), "S4": (15, 30), "S5": (15, 30), "S6": (15, 30), "S7": (15, 30)},
        "CDIS3": {"S1": (20, 40), "S2": (20, 40), "S3": (20, 40), "S4": (20, 40), "S5": (20, 40), "S6": (20, 40), "S7": (20, 40)},
        "Hoth": {"S1": (30, 60), "S2": (30, 60), "S3": (30, 60), "S4": (30, 60), "S5": (30, 60), "S6": (30, 60), "S7": (30, 60)},
        "Bungee1": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee2": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee3": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee4": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee5": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee6": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee7": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee8": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee9": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
    }

    pipeline = Pipeline(service_flows, schema_capacities)
    
    pipeline.run_cycle(service_flows)
    
    captured = capsys.readouterr()
        
    print("\n--- Full Pipeline Output ---")
    print(captured.out)
    print("--- End of Pipeline Output ---\n")