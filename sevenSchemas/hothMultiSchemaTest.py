
import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from crystal import Pipeline, ServiceStatus, ServiceAction  # Adjust import as needed

def test_hoth_overload(capsys):
    service_flows = {
        "C1": {"S1": (150, 150), "S2": (0, 0), "S3": (0, 0), "S4": (0, 0), "S5": (0, 0), "S6": (0, 0), "S7": (0, 0)},
        "C2": {"S1": (0, 0), "S2": (150, 150), "S3": (0, 0), "S4": (0, 0), "S5": (0, 0), "S6": (0, 0), "S7": (0, 0)},
        "C3": {"S1": (0, 0), "S2": (0, 0), "S3": (150, 150), "S4": (0, 0), "S5": (0, 0), "S6": (0, 0), "S7": (0, 0)},
        "C4": {"S1": (0, 0), "S2": (0, 0), "S3": (0, 0), "S4": (150, 150), "S5": (0, 0), "S6": (0, 0), "S7": (0, 0)},
        "C5": {"S1": (0, 0), "S2": (0, 0), "S3": (0, 0), "S4": (0, 0), "S5": (150, 150), "S6": (0, 0), "S7": (0, 0)},
        "C6": {"S1": (0, 0), "S2": (0, 0), "S3": (0, 0), "S4": (0, 0), "S5": (0, 0), "S6": (150, 150), "S7": (0, 0)},
        "C7": {"S1": (0, 0), "S2": (0, 0), "S3": (0, 0), "S4": (0, 0), "S5": (0, 0), "S6": (0, 0), "S7": (150, 150)},
        "AggStream": {"S1": (150, 150), "S2": (150, 150), "S3": (150, 150), "S4": (150, 150), "S5": (150, 150), "S6": (150, 150), "S7": (150, 150)},
        "SlowLane": {"S1": (0, 0), "S2": (0, 0), "S3": (0, 0), "S4": (0, 0), "S5": (0, 0), "S6": (0, 0), "S7": (0, 0)},
        "R1": {"S1": (75, 75), "S2": (75, 75), "S3": (75, 75), "S4": (75, 75), "S5": (75, 75), "S6": (75, 75), "S7": (75, 75)},
        "R2": {"S1": (75, 75), "S2": (75, 75), "S3": (75, 75), "S4": (75, 75), "S5": (75, 75), "S6": (75, 75), "S7": (75, 75)},
        "CDIS1": {"S1": (25, 25), "S2": (25, 25), "S3": (25, 25), "S4": (25, 25), "S5": (25, 25), "S6": (25, 25), "S7": (25, 25)},
        "CDIS2": {"S1": (25, 25), "S2": (25, 25), "S3": (25, 25), "S4": (25, 25), "S5": (25, 25), "S6": (25, 25), "S7": (25, 25)},
        "CDIS3": {"S1": (25, 25), "S2": (25, 25), "S3": (25, 25), "S4": (25, 25), "S5": (25, 25), "S6": (25, 25), "S7": (25, 25)},
        "Hoth": {"S1": (75, 75), "S2": (75, 75), "S3": (75, 75), "S4": (75, 75), "S5": (75, 75), "S6": (75, 75), "S7": (75, 75)},
        "Bungee1": {"S1": (10, 10), "S2": (10, 10), "S3": (10, 10), "S4": (10, 10), "S5": (10, 10), "S6": (10, 10), "S7": (10, 10)},
        "Bungee2": {"S1": (10, 10), "S2": (10, 10), "S3": (10, 10), "S4": (10, 10), "S5": (10, 10), "S6": (10, 10), "S7": (10, 10)},
        "Bungee3": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee4": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee5": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee6": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee7": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee8": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
        "Bungee9": {"S1": (5, 5), "S2": (5, 5), "S3": (5, 5), "S4": (5, 5), "S5": (5, 5), "S6": (5, 5), "S7": (5, 5)},
    }

    schema_capacities = {
        "C1": {"S1": (150, 200), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "C2": {"S1": (10, 20), "S2": (150, 200), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "C3": {"S1": (10, 20), "S2": (10, 20), "S3": (150, 200), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "C4": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (150, 200), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "C5": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (150, 200), "S6": (10, 20), "S7": (10, 20)},
        "C6": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (150, 200), "S7": (10, 20)},
        "C7": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (150, 200)},
        "AggStream": {"S1": (150, 300), "S2": (150, 300), "S3": (150, 300), "S4": (150, 300), "S5": (150, 300), "S6": (150, 300), "S7": (150, 300)},
        "SlowLane": {"S1": (50, 100), "S2": (50, 100), "S3": (50, 100), "S4": (50, 100), "S5": (50, 100), "S6": (50, 100), "S7": (50, 100)},
        "R1": {"S1": (75, 150), "S2": (75, 150), "S3": (75, 150), "S4": (75, 150), "S5": (75, 150), "S6": (75, 150), "S7": (75, 150)},
        "R2": {"S1": (75, 150), "S2": (75, 150), "S3": (75, 150), "S4": (75, 150), "S5": (75, 150), "S6": (75, 150), "S7": (75, 150)},
        "CDIS1": {"S1": (25, 50), "S2": (25, 50), "S3": (25, 50), "S4": (25, 50), "S5": (25, 50), "S6": (25, 50), "S7": (25, 50)},
        "CDIS2": {"S1": (25, 50), "S2": (25, 50), "S3": (25, 50), "S4": (25, 50), "S5": (25, 50), "S6": (25, 50), "S7": (25, 50)},
        "CDIS3": {"S1": (25, 50), "S2": (25, 50), "S3": (25, 50), "S4": (25, 50), "S5": (25, 50), "S6": (25, 50), "S7": (25, 50)},
        "Hoth": {"S1": (50, 70), "S2": (50, 70), "S3": (50, 70), "S4": (50, 70), "S5": (50, 70), "S6": (50, 70), "S7": (50, 70)},
        "Bungee1": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "Bungee2": {"S1": (10, 20), "S2": (10, 20), "S3": (10, 20), "S4": (10, 20), "S5": (10, 20), "S6": (10, 20), "S7": (10, 20)},
        "Bungee3": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee4": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee5": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee6": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee7": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee8": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
        "Bungee9": {"S1": (5, 15), "S2": (5, 15), "S3": (5, 15), "S4": (5, 15), "S5": (5, 15), "S6": (5, 15), "S7": (5, 15)},
    }
    graph = {
        "C1": ["AggStream", "SlowLane"],
        "C2": ["AggStream", "SlowLane"],
        "C3": ["AggStream", "SlowLane"],
        "C4": ["AggStream", "SlowLane"],
        "C5": ["AggStream", "SlowLane"],
        "C6": ["AggStream", "SlowLane"],
        "C7": ["AggStream", "SlowLane"],
        "AggStream": ["R1", "R2"],
        "SlowLane": ["AggStream"],
        "R1": ["CDIS1", "CDIS2", "CDIS3"],
        "R2": ["Hoth"],
        "CDIS1": [f"Bungee{i}" for i in range(1, 10)],
        "CDIS2": [f"Bungee{i}" for i in range(1, 10)],
        "CDIS3": [f"Bungee{i}" for i in range(1, 10)],
        "Hoth": [],
        "Bungee1": [], "Bungee2": [], "Bungee3": [], "Bungee4": [], "Bungee5": [],
        "Bungee6": [], "Bungee7": [], "Bungee8": [], "Bungee9": [],
    }

    schema_priorities = {
        "S1": 7, "S2": 6, "S3": 5, "S4": 4, "S5": 3, "S6": 2, "S7": 1
    }

    pipeline = Pipeline(service_flows, schema_capacities, graph, schema_priorities)
    
    pipeline.run_cycle(service_flows)
    
    captured = capsys.readouterr()
    
    print("\n--- Full Pipeline Output ---")
    print(captured.out)
    print("--- End of Pipeline Output ---\n")